name: Sanitize PRs
on:
  push:
    branches:
      - main-test

jobs:
  NBStrip:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      - uses: s-weigand/setup-conda@v1
        with:
          conda-channels: conda-forge
          python-version: '3.11'
      - run: python3 -m venv .venv
      - run: .venv/bin/python -m pip install nbstripout
      - uses: actions/checkout@v3
      - name: Clean Up The Notebooks Output
        # This will overwrite the history of the pushed commits to
        # remove unwanted information from the notebooks.
        run: |
          PYTHON=$(pwd)/.venv/bin/python
          BEFORE=${{ github.event.before }}
          AFTER=${{ github.event.after }}
          BASE=$(git merge-base main-test origin/main-test)
          COMMITS=$(git rev-list $BASE..HEAD)
          HEAD_HASH=$(git rev-parse HEAD)
          REMOTE_HEAD_HASH=$(git rev-parse origin/main-test)
          git branch
          echo Before: $BEFORE
          echo After: $AFTER
          # $AFTER is the same ash $HEAD_HASH
          echo Head hash: $HEAD_HASH
          echo Remote head hash: $REMOTE_HEAD_HASH
          # This is impossible
          # echo Range:
          # git rev-list $BEFORE..HEAD
          # This is empty (it's from head to head)
          echo Range 2:
          git rev-list $AFTER..HEAD
          # This is also impossible
          # echo Range 3:
          # git rev-list $BEFORE..$AFTER
          if [ "$COMMITS" = "" ] ; then
            echo No new commits
          else
            echo Merge-base: $BASE
            echo Will process commits: $COMMITS
            git config --global user.name "${{ github.actor }}"
            git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
            git filter-branch -f --index-filter "
            git checkout -- :*.ipynb
            find . -name \"*.ipynb\" -exec \"$PYTHON\" -c 'from nbstripout import _nbstripout ; _nbstripout.main()' \"{}\" +
            git add . --ignore-removal
            " $BASE..HEAD
            git push --force-with-lease
          fi
